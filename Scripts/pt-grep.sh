#!/usr/bin/env bash

######################################################################
# Author  : Hugo Torres de Lima <hugotorres@protonmail.com>          #
# Date    : 2021/08/15                                               #
# License : MIT                                                      #
# Version : 1.0                                                      #
######################################################################

# ====================================================================
# Variáveis
# ====================================================================

IP=''
PORTS=''
FILE="${1}"

# ====================================================================
# Função para exibir o banner.
# ====================================================================

function __banner__
{
    echo -e "
            +---------------------------------------------+
            |           Pentest-tools [ pt-grep ]         |
            |---------------------------------------------|
            | Script para organizar as portas encontradas |
            | pelo nmap. Sendo necessário que o arquivo   |
            | tenha sido salvo com a opção -oG.           |
            +---------------------------------------------+
            | Ex:                                         |
            |    nmap -nv -sS 192.168.0.1 -oG saida.txt   |
            |                                             |
            |    pt-grep saida.txt                        |
            +---------------------------------------------+"
}

# ====================================================================
# Verificar se os programas necessários estão instalados.
# ====================================================================

function __dependencias__
{
    progs=('grep' 'tr' 'cut')
    for prog in ${progs};do
        which "${prog}" 1>/dev/null
        if [[ "$?" == "1" ]];then
            echo "Necessário instalar ${prog}"
            exit 1
        fi
    done
}

# ====================================================================
# Verificar argumentos informados.
# ====================================================================

function __check__
{
    __dependencias__

    if [[ "$FILE" == "" ]];then
        __banner__
        echo -e "\n\t\t  !!! Arquivo não informado !!!"
        exit 1
    fi
}

# ====================================================================
# Filtra os IPs encontrados.
# ====================================================================

function __ip__
{
    IP=$(grep -ve "^#" "${FILE}" | \
         grep -i "host" |          \
         grep -iv "status" |       \
         cut -d " " -f2)
}

# ====================================================================
# Filtra as portas do IP informado.
# ====================================================================

function __ports__
{
    PORTS=$(grep -ve "^#" "${FILE}" | \
    grep " ${1} " |                   \
    grep -iv "status" |               \
    tr ' ' '\n' |                     \
    grep -ve "^[[:alpha:]]" |         \
    grep "\/" |                       \
    grep -ve "[:()]" |                \
    tr '/' '\n' |                     \
    grep "^[[:digit:]]" |             \
    grep -v "\.")
}

# ====================================================================
# Função principal.
# ====================================================================

function __main__
{
    __check__
    __ip__

    for hosts in ${IP};do
        __ports__ "${hosts}"

        echo -ne "\n\n${hosts} -p "
        for port in ${PORTS};do
            echo -n "${port},"
        done
    done
}

# ====================================================================
# Inicio do script.
# ====================================================================

__main__
